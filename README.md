# Интеграционный сервис Bitrix24 и Planfix

Этот проект представляет собой FastAPI-приложение для интеграции Битрикс24 и Planfix. Он автоматически создает или обновляет контакты/компании и задачи в Planfix на основе событий (вебхуков) из Битрикс24, связанных со сделками.

## Как работает проект

Проект представляет собой асинхронное веб-приложение на FastAPI, которое слушает входящие вебхуки от Bitrix24. При получении вебхука, содержащего ID сделки, сервис выполняет следующие шаги:

1.  **Получение данных из Bitrix24**: Используя Bitrix API, сервис запрашивает полную информацию о сделке, связанном контакте, компании, ответственном пользователе, а также реквизиты и адрес компании.
2.  **Поиск и создание/обновление сущностей в Planfix**:
      * Используя email ответственного пользователя из Битрикса, сервис пытается найти соответствующего пользователя в Planfix.
      * Сервис ищет контакт и компанию в Planfix по номеру телефона (для контакта) и ИНН/названию (для компании).
      * Если контакт или компания не найдены, они создаются в Planfix с данными из Битрикс24.
3.  **Создание задач в Planfix**: В Planfix создаются две связанные задачи:
      * Основная задача: "Подготовить и отправить клиенту договор и счёт."
      * Подзадача: "Подготовить дизайн."
        Обе задачи назначаются ответственному пользователю, найденному по email из Битрикса. К задачам также привязываются созданные/обновленные контакт и компания.

## Структура проекта

```
my_project/
├── app/
│   ├── api/
│   │   └── v1/
│   │       ├── endpoints.py           # Определяет эндпоинт для вебхука Bitrix24.
│   │       └── __init__.py
│   ├── bitrix/
│   │   └── bitrix_client.py         # Клиент для взаимодействия с Bitrix24 API (использует fast_bitrix24).
│   ├── core/
│   │   ├── config.py                # Настройки проекта и переменные окружения.
│   │   └── __init__.py
│   ├── dependencies.py              # Управление зависимостями и инициализация клиентов.
│   ├── planfix/
│   │   └── planfix_client.py        # Клиент для взаимодействия с Planfix API.
│   ├── schemas/
│   │   └── bitrix.py                # Pydantic-схемы для валидации данных.
│   └── services/
│       └── bitrix_deal_processor.py # Основная бизнес-логика обработки сделок Bitrix24.
├── .env.example                     # Пример файла с переменными окружения.
├── Dockerfile                       # Инструкции для сборки Docker-образа.
├── docker-compose.yml               # Описание сервисов для Docker Compose.
└── main.py                          # Точка входа в FastAPI приложение.
```

## Как использовать (развертывание и запуск)

### Предварительные требования

  * Docker и Docker Compose установлены.
  * Доступ к API Bitrix24 (webhook URL).
  * Доступ к API Planfix (API Key, Auth Token).
  * Настроенный исходящий вебхук в Bitrix24.

### Настройка переменных окружения

Создайте файл `.env` в корневой директории проекта (`my_project/`) на основе `.env.example` и заполните его своими данными:

```
BITRIX_WEBHOOK_URL="ВАШ_WEBHOOK_URL_BITRIX24_ДЛЯ_ИСХОДЯЩИХ_ЗАПРОСОВ_НА_БИТРИКС"
PLABFIX_API_URL="https://api.planfix.com/xml/" # Или другой URL, если у вас частный Planfix
PLANFIX_AUTH_TOKEN="ВАШ_AUTH_TOKEN_PLANFIX"
```

  * `BITRIX_WEBHOOK_URL`: Это URL для *исходящих* запросов вашего сервиса в Битрикс24 (для `fast-bitrix24`). Вы можете получить его в разделе "Разработчикам" -\> "Другое" -\> "Входящий вебхук" в Битрикс24.
  * `PLABFIX_API_URL`: Базовый URL для Planfix API.
  * `PLANFIX_AUTH_TOKEN`: Ваш токен авторизации для Planfix API.

### Запуск с использованием Docker Compose

Из корневой директории проекта (`my_project/`) выполните команду:

```bash
docker-compose up --build -d
```

Это соберет Docker-образ и запустит сервис в фоновом режиме. Приложение будет доступно на порту `9093`.

### Настройка вебхука в Bitrix24

Вам нужно настроить **исходящий вебхук** в Bitrix24, который будет срабатывать при определенных событиях (например, создании или изменении сделки) и отправлять данные в ваш сервис.

1.  **Перейдите в Bitrix24**: "Приложения" -\> "Разработчикам" -\> "Другое" -\> "Исходящий вебхук".
2.  **Настройте вебхук**:
      * **Адрес обработчика**: Укажите полный URL вашего запущенного сервиса. Если ваше приложение доступно по адресу `http://my-integration.com:9093`, то адрес обработчика будет:
        `http://my-integration.com:9093/`
      * **Параметры**: Важно, что сервис ожидает `deal_id` как query-параметр. В Bitrix24 вы должны настроить отправку `ID` сделки в URL. В поле "Поле для отправки" (или аналогичное) выберите ID сделки и укажите, что оно должно быть включено в URL.
          * **Пример URL для настройки**:
            `http://my-integration.com:9093/?deal_id=#ID#`
            (где `#ID#` - это плейсхолдер Bitrix24, который будет заменен на реальный ID сделки).
      * **Событие**: Выберите событие, которое будет триггерить вебхук (например, "При изменении сделки" или "При добавлении сделки" в CRM).

## Логика работы

### Получение данных из Bitrix24

  * **`app/bitrix/bitrix_client.py`**: Этот модуль содержит класс `BitrixClient`, который инкапсулирует взаимодействие с Bitrix24 API с помощью библиотеки `fast-bitrix24`. Он использует асинхронный клиент `BitrixAsync` для повышения производительности.
      * Методы `get_deal`, `get_contact`, `get_company`, `get_user` используются для получения детальной информации о соответствующих сущностях по их ID.
      * Методы `get_address` и `get_requisites` добавлены для получения адресов и реквизитов компаний из Битрикс24.
      * Метод `close` пуст, так как `fast_bitrix24` управляет сессиями самостоятельно.

### Обработка данных и взаимодействие с Planfix

  * **`app/services/bitrix_deal_processor.py`**: Класс `BitrixDealProcessor` содержит основную бизнес-логику обработки вебхука.
      * При получении `deal_id` он запрашивает полную информацию о сделке, контакте, компании и ответственном пользователе из Битрикс24.
      * **Извлечение контактных данных**: Особое внимание уделяется извлечению номеров телефонов и email-адресов из списков словарей (`"PHONE": [{...}], "EMAIL": [{...}]`), предоставленных Bitrix24. Берется первое найденное значение.
      * **Сопоставление пользователей**: `_get_planfix_user_id_from_bitrix_user` пытается найти ответственного пользователя в Planfix по email, полученному из Битрикс24.
      * **Создание/обновление контактов/компаний в Planfix**: Сервис сначала пытается найти контакт в Planfix по телефону, а компанию по ИНН или названию. Если сущности не найдены, они создаются с использованием соответствующих шаблонов Planfix и данных из Битрикс24, включая адрес и реквизиты.
  * **`app/planfix/planfix_client.py`**: Класс `PlanfixClient` обеспечивает взаимодействие с Planfix API.
      * Методы `get_contact`, `get_company`, `get_company_by_name`, `get_responsible_user_by_email` используются для поиска существующих сущностей в Planfix.
      * Метод `create_or_update_contact` используется для создания или обновления контакта/компании.
      * Метод `create_task` используется для создания задач.

### Создание задач в Planfix

  * После обработки данных и создания/обновления контакта и компании в Planfix, `BitrixDealProcessor` формирует описание задачи, включающее информацию о сделке, контакте и компании.
  * Создаются две задачи: основная ("Подготовить и отправить клиенту договор и счёт") и подзадача ("Подготовить дизайн"). Обе задачи назначаются ответственному пользователю и привязываются к соответствующей компании.